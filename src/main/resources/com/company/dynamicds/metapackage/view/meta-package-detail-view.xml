<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      title="Meta Package Configuration"
      focusComponent="form">

    <data>
        <collection id="dynamicDataStoreConfigsDc" class="com.company.dynamicds.dynamicds.entity.DynamicDataStoreConfig">
            <loader id="dynamicDataStoreConfigsDl" readOnly="true">
                <query>
                    <![CDATA[select e from dwh_DynamicDataStore e]]>
                </query>
            </loader>
            <fetchPlan extends="_base"/>
        </collection>
        <instance id="metaPackageDc" class="com.company.dynamicds.metapackage.entity.MetaPackage">
            <loader id="metaPackageDl"/>
            <fetchPlan extends="_base">
                <property name="sources" fetchPlan="_base">
                    <property name="metadataDefinition" fetchPlan="_base"/>
                    <property name="fieldMappings" fetchPlan="_base"/>
                </property>
                <property name="relationships" fetchPlan="_base"/>
            </fetchPlan>
            <!-- collection con thuộc entity đang edit -->
            <collection id="sourcesDc" property="sources"/>
            <collection id="relationshipsDc" property="relationships"/>
        </instance>

        <!-- con trỏ tới item đang chọn trong sourcesDc -->
        <instance id="selectedSourceDc"
                  class="com.company.dynamicds.metapackage.entity.MetaPackageSource"
                  container="sourcesDc">

            <!-- KHAI BÁO Ở ĐÂY: collection con dựa theo property của selectedSource -->
            <collection id="fieldMappingsDc" property="fieldMappings"/>
        </instance>
    </data>

    <facets>
        <dataLoadCoordinator auto="true"/>
    </facets>

    <actions>
        <action id="saveAction" type="detail_saveClose"/>
        <action id="closeAction" type="detail_close"/>
    </actions>

    <layout>
        <formLayout id="form" dataContainer="metaPackageDc">
            <responsiveSteps>
                <responsiveStep minWidth="0" columns="1"/>
                <responsiveStep minWidth="40em" columns="2"/>
            </responsiveSteps>
            <textField id="nameField" property="name" required="true"/>
            <comboBox id="storeNameField" property="storeName"/>
            <select id="mergeStrategyField" property="mergeStrategy" required="true"/>
            <checkbox id="isActiveField" property="isActive" enabled="false"
                      helperText="Use Activate/Deactivate buttons in list view"/>
            <textArea id="descriptionField" property="description" colspan="2" height="6em"/>
        </formLayout>

        <label text="Data Sources" classNames="text-xl font-semibold mt-m"/>

        <hbox width="100%">
            <button action="sourcesDataGrid.create"/>
            <button action="sourcesDataGrid.edit"/>
            <button action="sourcesDataGrid.remove"/>
        </hbox>

        <dataGrid id="sourcesDataGrid"
                  dataContainer="sourcesDc"
                  width="100%"
                  minHeight="15em"
                  columnReorderingAllowed="true">
            <actions>
                <action id="create" type="list_create"/>
                <action id="edit" type="list_edit"/>
                <action id="remove" type="list_remove"/>
            </actions>
            <columns resizable="true">
                <column property="alias" editable="true"/>
                <column property="metadataDefinition"/>
                <column property="orderIndex" editable="true"/>
            </columns>
        </dataGrid>

        <label text="Field Mappings" classNames="text-xl font-semibold mt-l"/>
        <label text="Select a source above to configure its field mappings"/>

        <details id="mappingsPanel" opened="true" summaryText="Field Mappings for Selected Source" width="100%">
            <hbox width="100%">
                <button action="fieldMappingsDataGrid.create"/>
                <button action="fieldMappingsDataGrid.edit"/>
                <button action="fieldMappingsDataGrid.remove"/>
            </hbox>

            <dataGrid id="fieldMappingsDataGrid"
                      dataContainer="fieldMappingsDc"
                      width="100%"
                      minHeight="15em"
                      columnReorderingAllowed="true">
                <actions>
                    <action id="create" type="list_create"/>
                    <action id="edit" type="list_edit"/>
                    <action id="remove" type="list_remove"/>
                </actions>
                <columns resizable="true">
                    <column property="sourceFieldName" editable="true"/>
                    <column property="targetFieldName" editable="true"/>
                    <column property="dataType" editable="true">
                        <comboBox id="dataTypeEditor" itemsEnum="com.company.dynamicds.dynamicds.entity.MetadataFieldType"/>
                    </column>
                    <column property="isRequired" editable="true"/>
                    <column property="transformScript"/>
                </columns>
            </dataGrid>
        </details>

        <label text="Relationships" classNames="text-xl font-semibold mt-l"/>
        <label text="Define how sources are joined together (like SQL JOIN)"/>

        <hbox width="100%">
            <button action="relationshipsDataGrid.create"/>
            <button action="relationshipsDataGrid.edit"/>
            <button action="relationshipsDataGrid.remove"/>
        </hbox>

        <dataGrid id="relationshipsDataGrid"
                  dataContainer="relationshipsDc"
                  width="100%"
                  minHeight="15em"
                  columnReorderingAllowed="true">
            <actions>
                <action id="create" type="list_create"/>
                <action id="edit" type="list_edit"/>
                <action id="remove" type="list_remove"/>
            </actions>
            <columns resizable="true">
                <column property="name" editable="true"/>
                <column property="sourceAlias" editable="true"/>
                <column property="sourceField" editable="true"/>
                <column property="targetAlias" editable="true"/>
                <column property="targetField" editable="true"/>
                <column property="relationshipType" editable="true">
                    <comboBox id="relationshipTypeEditor" itemsEnum="com.company.dynamicds.metapackage.enums.RelationshipType"/>
                </column>
                <column property="isActive" editable="true"/>
            </columns>
        </dataGrid>

        <hbox id="detailActions">
            <button id="saveAndCloseButton" action="saveAction"/>
            <button id="closeButton" action="closeAction"/>
        </hbox>
    </layout>
</view>
