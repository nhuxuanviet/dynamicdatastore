<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<view xmlns="http://jmix.io/schema/flowui/view"
      title="Meta Package Configuration"
      focusComponent="form">

    <!-- ===================== DATA ===================== -->
    <data>
        <!-- Danh sách DynamicDataStoreConfig (chỉ đọc) -->
        <collection id="dynamicDataStoreConfigsDc"
                    class="com.company.dynamicds.dynamicds.entity.DynamicDataStoreConfig">
            <loader id="dynamicDataStoreConfigsDl" readOnly="true">
                <query><![CDATA[
                    select e from dwh_DynamicDataStore e
                ]]></query>
            </loader>
            <fetchPlan extends="_base"/>
        </collection>

        <!-- MetaPackage đang edit -->
        <instance id="metaPackageDc"
                  class="com.company.dynamicds.metapackage.entity.MetaPackage">
            <loader id="metaPackageDl"/>
            <fetchPlan extends="_base">
                <property name="sources" fetchPlan="_base">
                    <property name="metadataDefinition" fetchPlan="_base"/>
                    <!-- Giữ hoặc bỏ fieldMappings cũng được; query riêng vẫn chạy -->
                    <property name="fieldMappings" fetchPlan="_base"/>
                </property>
                <property name="relationships" fetchPlan="_base"/>
            </fetchPlan>

            <!-- Collection con thuộc MetaPackage -->
            <collection id="sourcesDc" property="sources"/>
            <collection id="relationshipsDc" property="relationships"/>
        </instance>

        <!-- FieldMappings: KHÔNG nested container/property.
             Dùng query ràng buộc selection của sourcesDc bằng tham số :container_sourcesDc -->
        <collection id="fieldMappingsDc"
                    class="com.company.dynamicds.metapackage.entity.MetaPackageFieldMapping">
            <loader id="fieldMappingsDl">
                <query><![CDATA[
                    select e
                    from MetaPackageFieldMapping e
                    where e.metaPackageSource = :container_sourcesDc
                ]]></query>
            </loader>
            <fetchPlan extends="_base"/>
        </collection>
    </data>

    <!-- ===================== FACETS ===================== -->
    <facets>
        <!-- Khi đổi selection của sourcesDc, fieldMappingsDc tự reload -->
        <dataLoadCoordinator auto="true"/>
    </facets>

    <!-- ===================== ACTIONS (view) ===================== -->
    <actions>
        <action id="saveAction" type="detail_saveClose"/>
        <action id="closeAction" type="detail_close"/>
    </actions>

    <!-- ===================== LAYOUT ===================== -->
    <layout>

        <!-- Form MetaPackage -->
        <formLayout id="form" dataContainer="metaPackageDc">
            <responsiveSteps>
                <responsiveStep minWidth="0" columns="1"/>
                <responsiveStep minWidth="40em" columns="2"/>
            </responsiveSteps>

            <textField id="nameField" property="name" required="true"/>
            <textField id="storeNameField" property="storeName"/>
            <select id="mergeStrategyField" property="mergeStrategy" required="true"/>
            <checkbox id="isActiveField" property="isActive" enabled="false"
                      helperText="Use Activate/Deactivate buttons in list view"/>
            <textArea id="descriptionField" property="description" colspan="2" height="6em"/>
        </formLayout>

        <label text="Data Sources" classNames="text-xl font-semibold mt-m"/>

        <hbox width="100%">
            <button action="sourcesDataGrid.create"/>
            <button action="sourcesDataGrid.edit"/>
            <button action="sourcesDataGrid.remove"/>
        </hbox>

        <!-- GRID: Sources -->
        <dataGrid id="sourcesDataGrid"
                  dataContainer="sourcesDc"
                  width="100%"
                  minHeight="15em"
                  columnReorderingAllowed="true">
            <actions>
                <!-- list_* mặc định: mở detail view -->
                <action id="create" type="list_create"/>
                <action id="edit"   type="list_edit"/>
                <action id="remove" type="list_remove"/>
            </actions>
            <columns resizable="true">
                <column property="alias" editable="true"/>
                <column property="metadataDefinition"/>
                <column property="orderIndex" editable="true"/>
            </columns>
        </dataGrid>

        <label text="Field Mappings" classNames="text-xl font-semibold mt-l"/>
        <label text="Select a source above to configure its field mappings"/>

        <details id="mappingsPanel" opened="true" summaryText="Field Mappings for Selected Source" width="100%">

            <hbox width="100%">
                <!-- NÚT THƯỜNG: xử lý inline trong Java -->
                <button id="createInlineBtn" text="Add Mapping"/>
                <button id="editInlineBtn"   text="Edit Mapping"/>
                <button action="fieldMappingsDataGrid.remove"/>
            </hbox>

            <!-- GRID: Field Mappings -->
            <dataGrid id="fieldMappingsDataGrid"
                      dataContainer="fieldMappingsDc"
                      width="100%"
                      minHeight="15em"
                      columnReorderingAllowed="true">

                <actions>
                    <!-- Chỉ giữ remove mặc định -->
                    <action id="remove" type="list_remove"/>
                </actions>

                <columns resizable="true">
                    <column property="sourceFieldName" editable="true"/>
                    <column property="targetFieldName" editable="true"/>
                    <column property="dataType"       editable="true"/>
                    <column property="isRequired"     editable="true"/>
                    <column property="transformScript"/>
                </columns>

                <!-- Editor components đặt trong <editor> -->
                <editor buffered="false">
                    <field column="dataType">
                        <comboBox itemsEnum="com.company.dynamicds.dynamicds.entity.MetadataFieldType"/>
                    </field>
                </editor>
            </dataGrid>
        </details>

        <label text="Relationships" classNames="text-xl font-semibold mt-l"/>
        <label text="Define how sources are joined together (like SQL JOIN)"/>

        <hbox width="100%">
            <button action="relationshipsDataGrid.create"/>
            <button action="relationshipsDataGrid.edit"/>
            <button action="relationshipsDataGrid.remove"/>
        </hbox>

        <dataGrid id="relationshipsDataGrid"
                  dataContainer="relationshipsDc"
                  width="100%"
                  minHeight="15em"
                  columnReorderingAllowed="true">
            <actions>
                <action id="create" type="list_create"/>
                <action id="edit" type="list_edit"/>
                <action id="remove" type="list_remove"/>
            </actions>
            <columns resizable="true">
                <column property="name" editable="true"/>
                <column property="sourceAlias" editable="true"/>
                <column property="sourceField" editable="true"/>
                <column property="targetAlias" editable="true"/>
                <column property="targetField" editable="true"/>
                <column property="relationshipType" editable="true">
                    <comboBox id="relationshipTypeEditor" itemsEnum="com.company.dynamicds.metapackage.enums.RelationshipType"/>
                </column>
                <column property="isActive" editable="true"/>
            </columns>
        </dataGrid>

        <hbox id="detailActions">
            <button id="saveAndCloseButton" action="saveAction"/>
            <button id="closeButton" action="closeAction"/>
        </hbox>
    </layout>
</view>
