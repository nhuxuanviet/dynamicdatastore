<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <!-- MetaPackage Tables -->

    <changeSet id="1" author="system">
        <createTable tableName="DWH_META_PACKAGE">
            <column name="ID" type="${uuid.type}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="VERSION" type="INT" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED_BY" type="VARCHAR(255)"/>
            <column name="CREATED_DATE" type="TIMESTAMP"/>
            <column name="LAST_MODIFIED_BY" type="VARCHAR(255)"/>
            <column name="LAST_MODIFIED_DATE" type="TIMESTAMP"/>
            <column name="DELETED_BY" type="VARCHAR(255)"/>
            <column name="DELETED_DATE" type="TIMESTAMP"/>

            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="DESCRIPTION" type="CLOB"/>
            <column name="STORE_NAME" type="VARCHAR(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="MERGE_STRATEGY" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="IS_ACTIVE" type="BOOLEAN" defaultValueBoolean="false"/>
        </createTable>

        <createIndex tableName="DWH_META_PACKAGE" indexName="IDX_META_PACKAGE_STORE_NAME" unique="true">
            <column name="STORE_NAME"/>
        </createIndex>
    </changeSet>

    <changeSet id="2" author="system">
        <createTable tableName="DWH_META_PACKAGE_SOURCE">
            <column name="ID" type="${uuid.type}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="VERSION" type="INT" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED_BY" type="VARCHAR(255)"/>
            <column name="CREATED_DATE" type="TIMESTAMP"/>
            <column name="LAST_MODIFIED_BY" type="VARCHAR(255)"/>
            <column name="LAST_MODIFIED_DATE" type="TIMESTAMP"/>
            <column name="DELETED_BY" type="VARCHAR(255)"/>
            <column name="DELETED_DATE" type="TIMESTAMP"/>

            <column name="META_PACKAGE_ID" type="${uuid.type}">
                <constraints nullable="false"/>
            </column>
            <column name="ALIAS" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="METADATA_DEFINITION_ID" type="${uuid.type}">
                <constraints nullable="false"/>
            </column>
            <column name="ORDER_INDEX" type="INT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="DWH_META_PACKAGE_SOURCE"
                baseColumnNames="META_PACKAGE_ID"
                constraintName="FK_META_PKG_SRC_ON_META_PACKAGE"
                referencedTableName="DWH_META_PACKAGE"
                referencedColumnNames="ID"
                onDelete="CASCADE"/>

        <addForeignKeyConstraint
                baseTableName="DWH_META_PACKAGE_SOURCE"
                baseColumnNames="METADATA_DEFINITION_ID"
                constraintName="FK_META_PKG_SRC_ON_METADATA_DEF"
                referencedTableName="DWH_METADATA_DEFINITION"
                referencedColumnNames="ID"/>

        <createIndex tableName="DWH_META_PACKAGE_SOURCE" indexName="IDX_META_PKG_SRC_ALIAS" unique="true">
            <column name="META_PACKAGE_ID"/>
            <column name="ALIAS"/>
        </createIndex>
    </changeSet>

    <changeSet id="3" author="system">
        <createTable tableName="DWH_META_PACKAGE_FIELD_MAPPING">
            <column name="ID" type="${uuid.type}">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="VERSION" type="INT" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="CREATED_BY" type="VARCHAR(255)"/>
            <column name="CREATED_DATE" type="TIMESTAMP"/>
            <column name="LAST_MODIFIED_BY" type="VARCHAR(255)"/>
            <column name="LAST_MODIFIED_DATE" type="TIMESTAMP"/>
            <column name="DELETED_BY" type="VARCHAR(255)"/>
            <column name="DELETED_DATE" type="TIMESTAMP"/>

            <column name="META_PACKAGE_SOURCE_ID" type="${uuid.type}">
                <constraints nullable="false"/>
            </column>
            <column name="SOURCE_FIELD_NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TARGET_FIELD_NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="DATA_TYPE" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="TRANSFORM_SCRIPT" type="CLOB"/>
            <column name="IS_REQUIRED" type="BOOLEAN" defaultValueBoolean="false"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="DWH_META_PACKAGE_FIELD_MAPPING"
                baseColumnNames="META_PACKAGE_SOURCE_ID"
                constraintName="FK_META_PKG_FLD_ON_META_PKG_SRC"
                referencedTableName="DWH_META_PACKAGE_SOURCE"
                referencedColumnNames="ID"
                onDelete="CASCADE"/>

        <createIndex tableName="DWH_META_PACKAGE_FIELD_MAPPING" indexName="IDX_META_PKG_FLD_TARGET" unique="true">
            <column name="META_PACKAGE_SOURCE_ID"/>
            <column name="TARGET_FIELD_NAME"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
